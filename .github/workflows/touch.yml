name: Deploy Node.js Application to DigitalOcean

on:
  push:
    branches:
      - main  # Set this to the branch you want to deploy from

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Set up SSH connection
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
          SSH_AGENT_DEBUG: 1
        run: |
          eval `ssh-agent -a $SSH_AUTH_SOCK`
          ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"

      - name: Copy project to DigitalOcean server
        run: |
          rsync -avz --delete ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/sample

      - name: Install dependencies
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "cd sample && npm install"

      - name: Restart application
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "pm2 restart all"  # Assuming PM2 is used to manage your Node app
